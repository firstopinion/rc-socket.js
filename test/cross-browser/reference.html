<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- meta -->
        <meta charset="utf-8" />
        <title>rc-socket reference implementation</title>

        <!-- external script -->
        <script src="../../dist/rc-socket.js"></script>

        <!-- styles -->
        <!--<link rel="stylesheet" href="../node_modules/easy-build/node_modules/mocha/mocha.css" />-->
    </head>

    <!-- content -->
    <div id="workboard" style="position: absolute;"></div>
    <div id="mocha">
        <input type="button" onclick="createRcSocket();" value="StartSocket"/>
    </div>

    <!-- traces -->
    <script>
        var clientLogger;

        function createWindowLogger() {
            var childWin;
            var child = window.open('', 'childLogger');
            childWin = child.window;

            if (!childWin.clientLogger) {
                childWin.clientLogger = {
                    buffer: [],

                    debug: function () {
                        childWin.clientLogger.buffer.push({
                            ts: Date.now(),
                            message: arguments['0'] + ' ' + arguments['1'] + ' ' + arguments['2']
                        });
                    }
                };
            }

            return childWin.clientLogger;
        }

        function createLocalStorageLogger() {
            return {
                debug: function() {
                    localStorage.setItem(
                        String(Date.now()),
                        arguments['0'] + ' ' + arguments['1'] + ' ' + arguments['2']
                    );
                }
            }
        }

        var createRcSocket = function() {
            if(typeof(Storage) !== "undefined") {
                // Code for localStorage/sessionStorage.
                clientLogger = createLocalStorageLogger();
            } else {
                // no Web Storage support, fallback to Child Window buffer
                clientLogger = createWindowLogger();
            }

            var rc = new RcSocket("ws://localhost:9998/");
            rc.logger = clientLogger.debug;
            rc.debug = true;

            return rc;
        };

        var dumpLogger = function() {
            var buffer = [];
            for (var i = 0; i < localStorage.length; i++) {
                buffer.push({
                    ts: parseInt(localStorage.key(i)),
                    message: localStorage.getItem(localStorage.key(i))
                });
            }

            return buffer;
        };

        // Start RcSocket onLoad if the 'immediate' URL param is set
        if (window.location.search.replace("?", "").length) {
            createRcSocket();
            clientLogger.debug('RcSocket', 'startSocketImmediately', ' ');
        }
    </script>

    </body>
</html>