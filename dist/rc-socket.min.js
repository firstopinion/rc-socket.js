!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.RcSocket=b()}(this,function(){var a;return a=function(){var a=function(a,b){this.url=a,this.protocols=b,this.debug=!1,this.timeout=2500,this.maxRetry=1e3,this.delay=100,this.logger=console,this.hasUnloaded=!1,this.hasOpened=!1,this.wasForced=!1,this.isRetrying=!1,this.isRefreshing=!1,this.attempts=1,this.queue=[],window.onbeforeunload=function(){this.hasUnloaded=!0}.bind(this),setTimeout(this._connect.bind(this),0)};return a.prototype.send=function(a){return this.ws&&this.readyState?this.ws.send(a):void this.queue.unshift(a)},a.prototype.close=function(){this.wasForced=!0,this._close()},a.prototype.retry=function(){this.isRetrying=!0,this._close()},a.prototype.refresh=function(){this.isRefreshing=!0,this._close()},a.prototype._connect=function(){this.ws=new WebSocket(this.url,this.protocols),this.ws.onopen=this._onopen.bind(this),this.ws.onclose=this._onclose.bind(this),this.ws.onmessage=this._onmessage.bind(this),this.ws.onerror=this._onerror.bind(this),this.ws.id=Date.now(),this.connectTimer=setTimeout(function(){this._trigger("ontimeout"),this.retry()}.bind(this),this.timeout),this._stateChanged("CONNECTING","onconnecting")},a.prototype._onopen=function(a){return clearTimeout(this.connectTimer),this.wasForced?this.close():(this.hasOpened=!0,this.attempts=1,this._stateChanged("OPEN","onopen",a),void this._sendQueued())},a.prototype._onclose=function(a){clearTimeout(this.connectTimer),this.ws=null,a.forced=this.wasForced,a.isRetrying=this.isRetrying,a.isRefreshing=this.isRefreshing,this.wasForced?this._stateChanged("CLOSED","onclose",a):this.hasUnloaded||(this.hasOpened&&this._trigger("onclose",a),this.isRetrying=!1,this.isRefreshing=!1,this.hasOpened=!1,this._reconnect())},a.prototype._onmessage=function(a){this._trigger("onmessage",a)},a.prototype._onerror=function(a){this._trigger("onerror",a)},a.prototype._close=function(){this.ws&&this.ws.close()},a.prototype._reconnect=function(){var a=1e3*(Math.pow(2,this.attempts)-1);a=a>this.maxRetry?this.maxRetry:a,this.attempts++,setTimeout(this._connect.bind(this),a)},a.prototype._sendQueued=function(){for(var a=this.queue.length,b=a;b--;)this._delayQueueSend(b,a-b)},a.prototype._delayQueueSend=function(a,b){setTimeout(function(){this.send(this.queue[a]),this.queue.pop()}.bind(this),this.delay*b)},a.prototype._stateChanged=function(a,b,c){this.readyState=WebSocket[a],this._trigger(b,c)},a.prototype._trigger=function(b,c){(this.debug||a.debugAll)&&this.logger.debug("RcSocket",b,this.url,c),this[b]&&this[b](c)},a}()});