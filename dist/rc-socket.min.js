!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.RcSocket=b()}(this,function(){var a;return a=function(){var a=this,b=function(a,b){this.debug=!1,this.timeout=2500,this.maxRetry=1e3,this.delay=100,this.logger=console.debug,this.unload=!1,this.forced=!1,this.timedOut=!1,this.attempts=1,this.queue=[],this.protocols=b,this.URL=a,window.onbeforeunload=function(){this.unload=!0}.bind(this),setTimeout(this.connect.bind(this),0)};return b.prototype.connect=function(){this.ws=this.protocols?new WebSocket(this.URL,this.protocols):new WebSocket(this.URL),this._stateChanged("CONNECTING","onconnecting");var a=!1,b=this._setTimeout(this.ws);this.ws.onopen=function(c){return clearTimeout(b),this.forced?this.close():(a=!0,this.attempts=1,this._stateChanged("OPEN","onopen",c),void this._sendQueued())}.bind(this),this.ws.onclose=function(c){clearTimeout(b),this.ws=null,this.forced?this._stateChanged("CLOSED","onclose",c):this.unload||this._reconnect(c,a)}.bind(this),this.ws.onmessage=function(a){this._trigger("onmessage",a)}.bind(this),this.ws.onerror=function(a){this._trigger("onerror",a)}.bind(this)},b.prototype.send=function(a){return this.ws&&this.readyState?this.ws.send(a):void this.queue.unshift(a)},b.prototype.close=function(){this.forced=!0,this.ws&&this.ws.close()},b.prototype.refresh=function(){this.ws&&this.ws.close()},b.prototype._setTimeout=function(a){return setTimeout(function(){this._trigger("ontimeout"),this.timedOut=!0,a.close(),this.timedOut=!1}.bind(this),this.timeout)},b.prototype._reconnect=function(a,b){b&&!this.timedOut&&this._trigger("onclose",a),setTimeout(this.connect.bind(this),this._getInterval())},b.prototype._sendQueued=function(){var a=this.queue.length;for(i=a;i--;)this._delayQueueSend(i,a-i)},b.prototype._delayQueueSend=function(a,b){var c=this.delay*b;setTimeout(function(){this.send(this.queue[a]),this.queue.pop()}.bind(this),c)},b.prototype._stateChanged=function(a){this.readyState=WebSocket[a];var b=Array.prototype.slice.call(arguments,0);this._trigger.apply(this,b.slice(1,b.length))},b.prototype._trigger=function(c){var d=Array.prototype.slice.call(arguments,0);d.shift(),(this.debug||b.debugAll)&&this.logger.apply(a,["RcSocket",c,this.URL].concat(d)),this[c]&&this[c].apply(a,d)},b.prototype._getInterval=function(){var a=1e3*(Math.pow(2,this.attempts)-1);return this.attempts++,a>this.maxRetry?this.maxRetry:a},b.debugAll=!1,b}()});