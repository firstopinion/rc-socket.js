!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.RcSocket=b()}(this,function(){var a;return a=function(){var a=function(a,b){this.url=a,this.protocols=b,this.debug=!1,this.timeout=2500,this.maxRetry=1e3,this.delay=100,this.logger=console,this.hasUnloaded=!1,this.hasOpened=!1,this.wasForced=!1,this.isRetrying=!1,this.attempts=1,this.queue=[],window.onbeforeunload=function(){this.hasUnloaded=!0}.bind(this),setTimeout(this._connect.bind(this),0)};return a.prototype.send=function(a){return this.ws&&this.readyState&&!this.queue.length?this._send(a):this._addToQueue(a)},a.prototype.close=function(){this.wasForced=!0,this._close()},a.prototype.killSocket=function(){this.ws.onopen=null,this.ws.onclose=null,this.ws.onmessage=null,this.ws.onerror=null,this.close(),delete this.ws},a.prototype.reset=function(a){clearInterval(this.queueInterval),clearTimeout(this.connectTimer),this.queueInterval=null,this.connectTimer=null,this.hasUnloaded=!1,this.hasOpened=!1,this.wasForced=!1,this.isRetrying=!1,this.attempts=1,this.queue=a||[]},a.prototype.retry=function(){this.isRetrying=!0,this._close()},a.prototype.reboot=function(){this.killSocket(),this.reset(this.queue),this._connect()},a.prototype._connect=function(){this.ws=new WebSocket(this.url,this.protocols),this.ws.onopen=this._onopen.bind(this),this.ws.onclose=this._onclose.bind(this),this.ws.onmessage=this._onmessage.bind(this),this.ws.onerror=this._onerror.bind(this),this.ws.id=Date.now(),this.connectTimer=setTimeout(function(){this._trigger("ontimeout"),this.retry()}.bind(this),this.timeout),this._stateChanged("CONNECTING","onconnecting")},a.prototype._onopen=function(a){return clearTimeout(this.connectTimer),this.wasForced?this.close():(this.hasOpened=!0,this.attempts=1,this._stateChanged("OPEN","onopen",a),void this._sendQueued())},a.prototype._onclose=function(a){clearInterval(this.queueInterval),clearTimeout(this.connectTimer),this.ws=null,a.forced=this.wasForced,a.isRetrying=this.isRetrying,this.wasForced?this._stateChanged("CLOSED","onclose",a):this.hasUnloaded||(this.hasOpened&&this._trigger("onclose",a),this.isRetrying=!1,this.hasOpened=!1,this._reconnect())},a.prototype._onmessage=function(a){this._trigger("onmessage",a)},a.prototype._onerror=function(a){this._trigger("onerror",a)},a.prototype._close=function(){this.ws&&this.ws.close()},a.prototype._reconnect=function(){var a=1e3*(Math.pow(2,this.attempts)-1);a=a>this.maxRetry?this.maxRetry:a,this.attempts++,setTimeout(this._connect.bind(this),a)},a.prototype._send=function(a){this.ws&&this.ws.send(JSON.stringify(a))},a.prototype._addToQueue=function(a){return this.queue.push(a),a},a.prototype._shiftFromQueue=function(){return this.queue.shift()},a.prototype._sendQueued=function(){this.queue.length&&(this.queueInterval=setInterval(this._sendFromHead.bind(this),this.delay),this._sendFromHead())},a.prototype._sendFromHead=function(){this._send(this._shiftFromQueue()),this.queue.length||clearInterval(this.queueInterval)},a.prototype._stateChanged=function(a,b,c){this.readyState=WebSocket[a],this._trigger(b,c)},a.prototype._trigger=function(b,c){(this.debug||a.debugAll)&&this.logger.debug("RcSocket",b,this.url,c),this[b]&&this[b](c)},a}()});