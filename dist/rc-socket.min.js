!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).RcSocket={})}(this,(function(e){"use strict";var t=require("../internals/export"),n=require("../internals/array-for-each");t({target:"Array",proto:!0,forced:[].forEach!=n},{forEach:n});var o=require("../internals/redefine"),s=Date.prototype,i=s.toString,c=s.getTime;new Date(NaN)+""!="Invalid Date"&&o(s,"toString",(function(){var e=c.call(this);return e==e?i.call(this):"Invalid Date"}));var r=require("../internals/export"),a=require("../internals/object-assign");r({target:"Object",stat:!0,forced:Object.assign!==a},{assign:a});var l,u,h,_=require("../internals/global"),d=require("../internals/dom-iterables"),S=require("../internals/array-for-each"),y=require("../internals/create-non-enumerable-property");for(var f in d){var g=_[f],R=g&&g.prototype;if(R&&R.forEach!==S)try{y(R,"forEach",S)}catch(e){R.forEach=S}}function p(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}(l=e.RcSocketReadyState||(e.RcSocketReadyState={}))[l.CONNECTING=0]="CONNECTING",l[l.OPEN=1]="OPEN",l[l.CLOSING=2]="CLOSING",l[l.CLOSED=3]="CLOSED",(u=e.RcSocketCloseType||(e.RcSocketCloseType={}))[u.FORCE=0]="FORCE",u[u.KILL=1]="KILL",u[u.RETRY=2]="RETRY",(h=e.RcSocketEventName||(e.RcSocketEventName={})).CONNECTING="onconnecting",h.TIMEOUT="ontimeout",h.ERROR="onerror",h.OPEN="onopen",h.MESSAGE="onmessage",h.CLOSING="onclosing",h.CLOSE="onclose";var k=function(){function t(n,o,s){var i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),v(this,"settings",{debug:t.defaultSettings.debug,logger:t.defaultSettings.logger,connectionTimeout:t.defaultSettings.connectionTimeout,connectionMaxRetryInterval:t.defaultSettings.connectionMaxRetryInterval}),v(this,"url",void 0),v(this,"protocols",void 0),v(this,"onclose",null),v(this,"onerror",null),v(this,"onmessage",null),v(this,"onopen",null),v(this,"ontimeout",null),v(this,"onconnecting",null),v(this,"onclosing",null),v(this,"readyState",e.RcSocketReadyState.CONNECTING),v(this,"queue",[]),v(this,"_ws",null),v(this,"_attempts",1),v(this,"_shouldReopen",!1),v(this,"_closeType",null),v(this,"_connectTimer",null),this.url=n,this.protocols=o,Object.assign(this.settings,s),setTimeout((function(){return i.open()}),0)}var n,o,s;return n=t,(o=[{key:"open",value:function(){!this.readyState||this.readyState>WebSocket.CLOSING?(this.reset(),this._connect()):this.readyState===WebSocket.CLOSING&&(this._shouldReopen=!0)}},{key:"send",value:function(e){return this.readyState===WebSocket.OPEN?this._send(e):this.queue.push(e)}},{key:"close",value:function(){this._close(e.RcSocketCloseType.FORCE)}},{key:"kill",value:function(){this._close(e.RcSocketCloseType.KILL),this.reset()}},{key:"reboot",value:function(){this.kill(),this._connect()}},{key:"reset",value:function(){this._stop(),this._ws&&(this._ws.onopen=null,this._ws.onclose=null,this._ws.onmessage=null,this._ws.onerror=null),this._ws=null,this.readyState=e.RcSocketReadyState.CONNECTING,this._closeType=null,this._shouldReopen=!1,this._attempts=1}},{key:"_connect",value:function(){var t=this;this._ws=Object.assign(new WebSocket(this.url,this.protocols),{id:Date.now()}),this._ws.onopen=this._onopen.bind(this),this._ws.onclose=this._onclose.bind(this),this._ws.onmessage=this._onmessage.bind(this),this._ws.onerror=this._onerror.bind(this),this._connectTimer=setTimeout((function(){t._trigger(e.RcSocketEventName.TIMEOUT),t._close(e.RcSocketCloseType.RETRY)}),this.settings.connectionTimeout),this._stateChanged(e.RcSocketReadyState.CONNECTING,e.RcSocketEventName.CONNECTING)}},{key:"_stop",value:function(){this._connectTimer&&(clearTimeout(this._connectTimer),this._connectTimer=null)}},{key:"_onopen",value:function(t){if(this._connectTimer&&(clearTimeout(this._connectTimer),this._connectTimer=null),this._closeType===e.RcSocketCloseType.FORCE)return this.close();this._attempts=1,this._stateChanged(e.RcSocketReadyState.OPEN,e.RcSocketEventName.OPEN,t),this._sendQueued()}},{key:"_onclose",value:function(t){this._stop(),this._ws=null,this._closeType===e.RcSocketCloseType.FORCE?(this._stateChanged(e.RcSocketReadyState.CLOSED,e.RcSocketEventName.CLOSE,Object.assign(t,{forced:!0})),this._shouldReopen&&this.open()):(this._closeType!==e.RcSocketCloseType.RETRY&&this._trigger(e.RcSocketEventName.CLOSE,t),this._reconnect())}},{key:"_onmessage",value:function(t){this._trigger(e.RcSocketEventName.MESSAGE,t)}},{key:"_onerror",value:function(t){this._trigger(e.RcSocketEventName.ERROR,t)}},{key:"_close",value:function(t){this._closeType=t,this._shouldReopen=!1,this._ws&&this.readyState<WebSocket.CLOSING&&(this._ws.close(),this._stateChanged(e.RcSocketReadyState.CLOSING,e.RcSocketEventName.CLOSING))}},{key:"_reconnect",value:function(){var e=this,t=1e3*(Math.pow(2,this._attempts)-1);t=t>this.settings.connectionMaxRetryInterval?this.settings.connectionMaxRetryInterval:t,this._attempts++,setTimeout((function(){return e._connect()}),t)}},{key:"_send",value:function(e){this._ws&&this._sendPayload(JSON.stringify(e))}},{key:"_sendPayload",value:function(e){this._ws&&this._ws.send(e)}},{key:"_sendQueued",value:function(){var e=this;this.queue.forEach((function(t){return e._send(t)}))}},{key:"_stateChanged",value:function(e,t,n){this.readyState=e,this._trigger(t,n)}},{key:"_trigger",value:function(e,t){this.settings.debug&&this.settings.logger.debug("RcSocket",e,this.url,t);var n=this[e];n&&n.call(this._ws,t)}}])&&p(n.prototype,o),s&&p(n,s),t}();v(k,"defaultSettings",{debug:!1,logger:console,connectionTimeout:2500,connectionMaxRetryInterval:1e3}),e.default=k,Object.defineProperty(e,"__esModule",{value:!0})}));
