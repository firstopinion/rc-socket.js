!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.returnExportsGlobal=b()}):"object"==typeof exports?module.exports=b():a.RcSocket=b()}(this,function(){var a,b,c;return a=function(a){return"[object Array]"===Object.prototype.toString.call(a)},b=function(b){var c=a,d=function(a){this.processFn=a,this.tasks=[],this.indexes={},this.indexName=this.indexName||"id"};return d.prototype.add=function(a,b){var d=this.isEmpty(),e=c(a)?this._addTasks(a):this._addTask(a);return d&&b&&this.process(),e},d.prototype.isEmpty=function(){return!this.tasks.length},d.prototype.process=function(){var a=this;this.processFn(this._shift(),function(){return a.isEmpty()?null:a.process.call(a)})},d.prototype._addTasks=function(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(this._addTask(a[c]));return b},d.prototype._addTask=function(a){return this._isDuplicate(a)||this._push(a),a},d.prototype._isDuplicate=function(a){return this.indexes.hasOwnProperty(a[this.indexName])},d.prototype._push=function(a){var b=this.tasks.push(a)-1;a.hasOwnProperty(this.indexName)&&(this.indexes[a[this.indexName]]=b)},d.prototype._shift=function(){var a=this.tasks.shift();return delete this.indexes[a.indexName],a},d}({}),c=function(a){var c=b,d=function(a,b){this.url=a,this.protocols=b,this.debug=!1,this.timeout=2500,this.maxRetry=1e3,this.delay=100,this.logger=console,this.hasUnloaded=!1,this.hasOpened=!1,this.wasForced=!1,this.isRetrying=!1,this.attempts=1,this.queue=new c(this._processQueueTask.bind(this)),window.onbeforeunload=function(){this.hasUnloaded=!0}.bind(this),setTimeout(this._connect.bind(this),0)};return d.prototype.send=function(a){return this.ws&&this.readyState&&this.queue.isEmpty()?this._send(a):this.queue.add(a)},d.prototype.close=function(){this.wasForced=!0,this._close()},d.prototype.killSocket=function(){this.ws.onopen=null,this.ws.onclose=null,this.ws.onmessage=null,this.ws.onerror=null,this.close(),delete this.ws},d.prototype.reset=function(){clearTimeout(this.queueTimer),clearTimeout(this.connectTimer),this.queueTimer=null,this.connectTimer=null,this.hasUnloaded=!1,this.hasOpened=!1,this.wasForced=!1,this.isRetrying=!1,this.attempts=1},d.prototype.retry=function(){this.isRetrying=!0,this._close()},d.prototype.reboot=function(){this.killSocket(),this.reset(),this._connect()},d.prototype._connect=function(){this.ws=new WebSocket(this.url,this.protocols),this.ws.onopen=this._onopen.bind(this),this.ws.onclose=this._onclose.bind(this),this.ws.onmessage=this._onmessage.bind(this),this.ws.onerror=this._onerror.bind(this),this.ws.id=Date.now(),this.connectTimer=setTimeout(function(){this._trigger("ontimeout"),this.retry()}.bind(this),this.timeout),this._stateChanged("CONNECTING","onconnecting")},d.prototype._onopen=function(a){return clearTimeout(this.connectTimer),this.wasForced?this.close():(this.hasOpened=!0,this.attempts=1,this._stateChanged("OPEN","onopen",a),void this._sendQueued())},d.prototype._onclose=function(a){clearTimeout(this.queueTimer),clearTimeout(this.connectTimer),this.ws=null,a.forced=this.wasForced,a.isRetrying=this.isRetrying,this.wasForced?this._stateChanged("CLOSED","onclose",a):this.hasUnloaded||(this.hasOpened&&this._trigger("onclose",a),this.isRetrying=!1,this.hasOpened=!1,this._reconnect())},d.prototype._onmessage=function(a){this._trigger("onmessage",a)},d.prototype._onerror=function(a){this._trigger("onerror",a)},d.prototype._close=function(){this.ws&&this.ws.close()},d.prototype._reconnect=function(){var a=1e3*(Math.pow(2,this.attempts)-1);a=a>this.maxRetry?this.maxRetry:a,this.attempts++,setTimeout(this._connect.bind(this),a)},d.prototype._send=function(a){this.ws&&this.ws.send(JSON.stringify(a))},d.prototype._sendQueued=function(){this.queue.isEmpty()||this.queue.process()},d.prototype._processQueueTask=function(a,b){this._send(a),this.queue.isEmpty()||(this.queueTimer=setTimeout(b,this.delay))},d.prototype._stateChanged=function(a,b,c){this.readyState=WebSocket[a],this._trigger(b,c)},d.prototype._trigger=function(a,b){(this.debug||d.debugAll)&&this.logger.debug("RcSocket",a,this.url,b),this[a]&&this[a](b)},d}({})});