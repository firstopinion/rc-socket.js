var rcSocket=function(){var a=this,b=function(a,b){this.debug=!1,this.timeout=2500,this.maxRetry=1e3,this.logger=console.debug,this.unload=!1,this.forced=!1,this.timedOut=!1,this.attempts=1,this.queue=[],this.protocols=b,this.URL=a,window.onbeforeunload=function(){this.unload=!0}.bind(this),setTimeout(this.connect.bind(this),0)};return b.prototype.connect=function(){this.ws=this.protocols?new WebSocket(this.URL,this.protocols):new WebSocket(this.URL),this._stateChanged("CONNECTING","onconnecting");var a=!0,b=this._setTimeout(this.ws);this.ws.onopen=function(c){clearTimeout(b),a=!1,this.attempts=1,this._stateChanged("OPEN","onopen",c),this._sendQueued()}.bind(this),this.ws.onclose=function(c){clearTimeout(b),this.ws=null,this.forced?this._stateChanged("CLOSED","onclose",c):this.unload||this._reconnect(c,a)}.bind(this),this.ws.onmessage=function(a){this._trigger("onmessage",a)}.bind(this),this.ws.onerror=function(a){this._trigger("onerror",a)}.bind(this)},b.prototype.send=function(a){return this.ws&&this.readyState?this.ws.send(a):void this.queue.push(a)},b.prototype.close=function(){this.forced=!0,this.ws&&this.ws.close()},b.prototype.refresh=function(){this.ws&&this.ws.close()},b.prototype._setTimeout=function(a){return setTimeout(function(){this._trigger("ontimeout"),this.timedOut=!0,a.close(),this.timedOut=!1}.bind(this),this.timeout)},b.prototype._reconnect=function(a,b){b||this.timedOut||this._trigger("onclose",a),setTimeout(this.connect.bind(this),this._getInterval())},b.prototype._sendQueued=function(){for(var a=0,b=this.queue.length;b>a;a++)this.send(this.queue[a]),this.queue.shift()},b.prototype._stateChanged=function(a){this.readyState=WebSocket[a];var b=Array.prototype.slice.call(arguments,0);this._trigger.apply(this,b.slice(1,b.length))},b.prototype._trigger=function(c){var d=Array.prototype.slice.call(arguments,0);d.shift(),(this.debug||b.debugAll)&&this.logger.apply(a,["RcSocket",c,this.URL].concat(d)),this[c]&&this[c](d)},b.prototype._getInterval=function(){var a=1e3*(Math.pow(2,this.attempts)-1);return this.attempts++,a>this.maxRetry?this.maxRetry:a},b.debugAll=!1,b}();module.exports=rcSocket;